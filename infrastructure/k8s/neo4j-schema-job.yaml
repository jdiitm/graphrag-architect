apiVersion: batch/v1
kind: Job
metadata:
  name: neo4j-schema-init
  namespace: graphrag
  labels:
    app: neo4j-schema-init
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: neo4j-schema-init
    spec:
      restartPolicy: OnFailure
      containers:
        - name: schema-init
          image: neo4j:5.26-community
          command:
            - /bin/bash
            - -c
            - |
              until cypher-shell -u "$NEO4J_USERNAME" -p "$NEO4J_PASSWORD" -a "$NEO4J_URI" "RETURN 1"; do
                echo "Waiting for Neo4j..."
                sleep 5
              done
              cypher-shell -u "$NEO4J_USERNAME" -p "$NEO4J_PASSWORD" -a "$NEO4J_URI" < /schema/schema_init.cypher
              echo "Schema initialized."
          envFrom:
            - configMapRef:
                name: graphrag-config
            - secretRef:
                name: graphrag-secrets
          volumeMounts:
            - name: schema
              mountPath: /schema
      volumes:
        - name: schema
          configMap:
            name: neo4j-schema
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: neo4j-schema
  namespace: graphrag
data:
  schema_init.cypher: |
    -- NOTE: keep in sync with orchestrator/app/schema_init.cypher (canonical source)
    DROP CONSTRAINT service_id IF EXISTS;
    DROP CONSTRAINT database_id IF EXISTS;
    DROP CONSTRAINT topic_name IF EXISTS;
    DROP CONSTRAINT k8s_deploy_id IF EXISTS;
    DROP CONSTRAINT k8s_pod_id IF EXISTS;
    DROP CONSTRAINT service_tenant IF EXISTS;
    DROP CONSTRAINT database_tenant IF EXISTS;
    DROP CONSTRAINT topic_tenant IF EXISTS;
    DROP CONSTRAINT deployment_tenant IF EXISTS;
    CREATE CONSTRAINT service_tenant_id IF NOT EXISTS FOR (s:Service) REQUIRE (s.tenant_id, s.id) IS NODE KEY;
    CREATE CONSTRAINT database_tenant_id IF NOT EXISTS FOR (d:Database) REQUIRE (d.tenant_id, d.id) IS NODE KEY;
    CREATE CONSTRAINT topic_tenant_name IF NOT EXISTS FOR (t:KafkaTopic) REQUIRE (t.tenant_id, t.name) IS NODE KEY;
    CREATE CONSTRAINT k8s_deploy_tenant_id IF NOT EXISTS FOR (k:K8sDeployment) REQUIRE (k.tenant_id, k.id) IS NODE KEY;
    CREATE CONSTRAINT k8s_pod_tenant_id IF NOT EXISTS FOR (p:K8sPod) REQUIRE (p.tenant_id, p.id) IS NODE KEY;
    CREATE INDEX service_tenant_idx IF NOT EXISTS FOR (s:Service) ON (s.tenant_id);
    CREATE INDEX database_tenant_idx IF NOT EXISTS FOR (d:Database) ON (d.tenant_id);
    CREATE INDEX topic_tenant_idx IF NOT EXISTS FOR (t:KafkaTopic) ON (t.tenant_id);
    CREATE INDEX deployment_tenant_idx IF NOT EXISTS FOR (k:K8sDeployment) ON (k.tenant_id);
    CREATE INDEX service_lang_idx IF NOT EXISTS FOR (s:Service) ON (s.language);
    CREATE INDEX service_framework_idx IF NOT EXISTS FOR (s:Service) ON (s.framework);
    CREATE FULLTEXT INDEX service_name_index IF NOT EXISTS FOR (n:Service) ON EACH [n.name];
