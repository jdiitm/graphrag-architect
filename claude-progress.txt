## Completed: DLQ Error Handling + Infrastructure Fixes

Branch: `feat/dlq-error-handling-and-infra-fixes`
Quality Gates: Pylint 10/10, Python 260/260, Go 49/49

### Audit Findings Addressed

1. **HIGH 3.1** — DLQ handler silently discards sink errors (data loss vector)
   - Extended PipelineObserver with RecordDLQSinkError()
   - Added `ingestion_dlq_sink_error_total` Prometheus counter
   - Modified Handler to log errors via slog and emit metrics via observer
   - Used functional options pattern (WithObserver, WithLogger) matching dispatcher/consumer
   - Wired observer into production main.go
   - 4 new tests: error metric recording, continues after error, no metric on success, logger option

2. **HIGH 3.2** — HPA consumer lag metric name and label mismatch
   - Fixed hpa.yaml: metric name `ingestion_consumer_lag` (was `_total`)
   - Removed incorrect `consumer_group` label selector (metric uses topic/partition labels)

3. **Minor 4.1** — Network policies block OTLP telemetry export
   - Added port 4317 egress to orchestrator network policy (otel-collector pod)
   - Added port 4317 egress to ingestion-worker network policy (otel-collector pod)

4. **Minor 4.2** — Inline pylint suppression violates CLAUDE.md
   - Moved broad-except suppression to pyproject.toml (W0718) with justification comment
   - Removed inline `# pylint: disable=broad-except` from observability.py

---

## Project Status: Feature-Complete

All functional requirements (FR-1 through FR-8) and non-functional requirements
have been implemented, tested, and merged to main.

---

## Implementation Summary

### Phase 1: Core Pipeline

| Feature | Module | Status |
|---|---|---|
| FR-1: Async Kafka Ingestion | `workers/ingestion/` | Complete |
| FR-2: LLM Entity Extraction | `orchestrator/app/llm_extraction.py` | Complete |
| FR-3: Neo4j Persistence | `orchestrator/app/neo4j_client.py` | Complete |
| FR-4: Hybrid Query Routing | `orchestrator/app/query_engine.py` | Complete |
| FR-5: Schema Validation Loop | `orchestrator/app/schema_validation.py` | Complete |
| FR-6: DLQ Fault Tolerance | `workers/ingestion/internal/dlq/` | Complete |

### Phase 2: Cross-Cutting Concerns

| Feature | Module | Status |
|---|---|---|
| FR-7: Access Control | `orchestrator/app/access_control.py` | Complete |
| FR-8: Observability (Python) | `orchestrator/app/observability.py` | Complete |
| FR-8: Observability (Go) | `workers/ingestion/internal/telemetry/` | Complete |

### Phase 3: NFR Hardening & Deployment

| Item | Module | Status |
|---|---|---|
| Circuit Breaker (NFR-6) | `orchestrator/app/circuit_breaker.py` | Complete |
| Error-Aware Sampling (NFR-8) | `orchestrator/app/observability.py` | Complete |
| Prometheus Metrics Wiring | `workers/ingestion/internal/metrics/` | Complete |
| Integration Tests | `orchestrator/tests/test_integration.py` | Complete |
| CI/CD Pipeline | `.github/workflows/ci.yml` | Complete |
| Dockerfiles | `orchestrator/Dockerfile`, `workers/ingestion/Dockerfile` | Complete |
| K8s Manifests | `infrastructure/k8s/` | Complete |
| StatefulSets (Neo4j, Kafka) | `infrastructure/k8s/` | Complete |
| Ingress, NetworkPolicies | `infrastructure/k8s/` | Complete |
| Alerting (PrometheusRule) | `infrastructure/k8s/alerting.yaml` | Complete |

---

## Architecture

- Python orchestrator: FastAPI + LangGraph (ingestion DAG + query DAG)
- Go ingestion workers: Kafka consumer, dispatcher, forwarding processor, DLQ
- Neo4j 5.26: Knowledge graph with 5 constraints, 3 indexes, fulltext search
- Apache Kafka 3.9: KRaft mode, at-least-once delivery
- OpenTelemetry: Distributed tracing across Go -> HTTP -> Python boundary
- Prometheus: Consumer lag, batch duration, DLQ rate, jobs processed metrics

---

## Quality Gates

All gates pass before every push:
1. Pylint: 10/10
2. Python tests: all passing
3. Go tests: all passing
